## This is the codebase for the Washtenaw County's Drupal 8 website

This project involved creating a virtual machine on my Apple Macbook Pro,
creating a Drupal 8 website on that virtual machine, and then migrating the
the exisiting Washtenaw County Drupal 7 website to that "virtual" Drupal 8
machine.  I used Jeff [geerlingguy] Geerling's excellent youtube "how to"
series go guide me through this process.

The code on my Macbook Pro "host" machine is contained in the wash-gop-com
directory.  Jeff created a Docker container for this project. I decided to
use his vagrant virtual technology with which I am already familiar. Inside
the wash-gop-com directory is a directory called Vagrantcode; this directory
houses the code necessary to create the virtual machine that I used.

As did Jeff, I have automated the process of "installing" drupal.  In doing
so, I've learned a bit about what is actually happening when you do an
installation: specifically, that this is the point in the process that
your drupal database is set up and initialized.  Here is the code
within my config.yml file that does the drupal installation:

```
# Run specified scripts before or after VM is provisioned. 
# Use {{ playbook_dir }} to reference the provisioning/ folder in Drupal VM
# or {{ config_dir }} to reference the directory where your `config.yml` is.
pre_provision_scripts: []
post_provision_scripts:
     - "{{ playbook_dir }}/../wcgopsite/scripts/drushsiteinstall.sh"
``` 

Here is the shell script drushsiteinstall.sh that does the drupal installation.
Note that we also re-set the admin password so we do not have to remember a
new password with each drupal install.

```
cd /var/www/drupal8vm/web
drush site:install minimal
   --site-name="WCGOP"  -y 
drush upwd "admin" "wd17hh21"
```

After downloading and installing composer in the wash-gop-com directory
[instructions for doing this can be found at http://getcomposer.org/download],
we create the initial codebase for the website via the following command:

```
composer -n --prefer-dist create-project drupal/recommended-project:^8
```

We also add a .gitignore file to the wash-gop-com directory that minimizes the
code that actually gets uploaded to the repository.


We also added the block_content module [ this was done from the Extend menu]
and also added three additional modules needed for migration as follows:

```
	COMPOSER_MEMORY_LIMIT=-1 composer require drupal/migrate_upgrade:^3.2
	    drupal/migrate_plus:^4.2 drupal/migrate_tools:^4.5
```

At this point we were prepared to begin doing the migration work, and this is
where we made our first commit to the wash-gop-com repository.

Before actually starting the migration work, thouogh, it was necessary to
make a copy of my exisitng Drupal 7 database available to the D8 virtual
machine.  This was a fairly straightforward process:

* Use mysqldump to create a copy of the existing D7 database [a .sql file]
* FTP that copy down to my Macbook
* Place that copy in the wash-gop-com directory
* Use mysql commands to import the .sql file to a database
* Add another database to the settings.php file as follows:
```
$databases['migrate']['default'] = array (
  'database' => 'washgopc_GOPV7V2',
  'username' => 'gopdbadmin',
  'password' => '18WMTNwcta65',
  'prefix' => '',
  'host' => 'localhost',
  'port' => '3306',
  'namespace' => 'Drupal\\Core\\Database\\Driver\\mysql',
  'driver' => 'mysql',
);
```
In this case, "drupal7" is the legacy_db_key that will be used in the drush
migrate-upgrade command; database, username, and password are the parameters
used to access the drupal7 database.  [It was, of course,  necessary to use
mysql to add the gopdbadmin user and password].  Perhaps less obviously, it
was also necessary to add the user washgopc_gopdb; this is the user over on
the production site that actually created the .sql file we're trying to
import.

The drush command to create the migrations was then as follows:
```
drush migrate-upgrade --legacy-db-key=drupal7
      --legacy-root=https://www/wash-gop.com --configure-only
```
A word about migrations.  I'm not quite sure what they are and I spent a day
trying figure out how drupal remembers them.  Suffice it to say that drupal
DOES rmemember them, and that you can see them by going to
structure->migrations.  In my case, the migrations generated by the
migrate-upgrade command all belong to a "group" called migrate_drupal_7; we'll
use that group below in the drush migrate-import command.

-------------second commit-------------

The command to do the migrations is called import and it looks like this:
```
drush migrate-import --group=migrate_drupal_7
```
When I run this command the first time, the upgrade_d7_filter_format migration
fails with the following message:
```
4/9 [============>---------------]  44% [error]  The "" plugin does not exist.
Valid plugin IDs for Drupal\filter\FilterPluginManager are:
filter_html_image_secure, filter_url, filter_null, filter_html, filter_autop,
filter_align, filter_caption, filter_htmlcorrector, filter_html_escape 
(/var/www/drupal8vm/web/core/lib/Drupal/Component/Plugin/Discovery/DiscoveryTrait.php:53)
[error]  Missing filter plugin: filter_null.
```
 [notice] Processed 9 items (8 created, 0 updated, 1 failed, 0 ignored) - done with 'upgrade_d7_filter_format'
 
 
 
 -------------third commit-------------
 
 July 30, 2020 OK, it is now about 25 days since my last commit, and I have
 made some major changes in direction.  First, in early July I decided to
 abandon Vagrant and go with the Docker approach that Jeff was using.
 Here are some comments about that process:
 
 
 Stuff from July 8, 2020
 
 I made slight modifications to Jeff's naming conventions:
 
 * In my build command, I changed the name of the image I'm building to
 wdseelig:latest so this command looks like this:
    docker build -t wdseelig:latest .
    docker-compose up -d
 
 * In my config.yml file I changed the image: to wdseelig:latest [the one I 
 just built above] and the container name to WCGOP
 
 * I added a second mysql container to hold the old Drupal 7 database. My
 docker-compose.yml file now creates 3 containers
 
 Once that was completed and I had a crude and preliminary version of my site
 running in a Docker container, I started running into still more problems with
 migrations, so I decided that I needed to have an IDE working with my system.
 It took several days to accomplish this, but on Sunday, July 26th, a red
 letter day if there ever was one,  I got that working, and by Thursday,
 July 30th, I was ready to make the commit that would capture the status.
 Here is the process that I went through:
 
* Started with Jeff's Dockerfile and a docker-compose.yml file to create the
Docker containers
* Included the following additions:
 	* installed xdebug and sshd server
 	* Wrote necessary xdebug configuration information to
 	/etc/php/7.4/mods-available/xdebug.ini file
 	* Installed the vim editor [necessary if I want to edit system files]
 	* Wrote ssh key information to /root/.ssh/authorized_keys file
* I spent a day and a half (!) trying to figure out how to start Apache and
sshd automatically when I brought up my containers.  I eventually gave up on
this and just created an alias, dssh, to start ssh service on my container. 
 