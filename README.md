## This is the codebase for the Washtenaw County's Drupal 8 website

This project involved creating a virtual machine on my Apple Macbook Pro,
creating a Drupal 8 website on that virtual machine, and then migrating the
the exisiting Washtenaw County Drupal 7 website to that "virtual" Drupal 8
machine.  I used Jeff [geerlingguy] Geerling's excellent youtube "how to"
series go guide me through this process.

The code on my Macbook Pro "host" machine is contained in the wash-gop-com
directory.  Jeff created a Docker container for this project. I decided to
use his vagrant virtual technology with which I am already familiar. Inside
the wash-gop-com directory is a directory called Vagrantcode; this directory
houses the code necessary to create the virtual machine that I used.

As did Jeff, I have automated the process of "installing" drupal.  In doing
so, I've learned a bit about what is actually happening when you do an
installation: specifically, that this is the point in the process that
your drupal database is set up and initialized.  Here is the code
within my config.yml file that does the drupal installation:

```
# Run specified scripts before or after VM is provisioned. 
# Use {{ playbook_dir }} to reference the provisioning/ folder in Drupal VM
# or {{ config_dir }} to reference the directory where your `config.yml` is.
pre_provision_scripts: []
post_provision_scripts:
     - "{{ playbook_dir }}/../wcgopsite/scripts/drushsiteinstall.sh"
``` 

Here is the shell script drushsiteinstall.sh that does the drupal installation.
Note that we also re-set the admin password so we do not have to remember a
new password with each drupal install.

```
cd /var/www/drupal8vm/web
drush site:install minimal
   --site-name="WCGOP"  -y 
drush upwd "admin" "wd17hh21"
```

After downloading and installing composer in the wash-gop-com directory
[instructions for doing this can be found at http://getcomposer.org/download],
we create the initial codebase for the website via the following command:

```
composer -n --prefer-dist create-project drupal/recommended-project:^8
```

We also add a .gitignore file to the wash-gop-com directory that minimizes the
code that actually gets uploaded to the repository.


We also added the block_content module [ this was done from the Extend menu]
and also added three additional modules needed for migration as follows:

```
	COMPOSER_MEMORY_LIMIT=-1 composer require drupal/migrate_upgrade:^3.2
	    drupal/migrate_plus:^4.2 drupal/migrate_tools:^4.5
```

At this point we were prepared to begin doing the migration work, and this is
where we made our first commit to the wash-gop-com repository.

Before actually starting the migration work, thouogh, it was necessary to
make a copy of my exisitng Drupal 7 database available to the D8 virtual
machine.  This was a fairly straightforward process:

* Use mysqldump to create a copy of the existing D7 database [a .sql file]
* FTP that copy down to my Macbook
* Place that copy in the wash-gop-com directory
* Use mysql commands to import the .sql file to a database
* Add another database to the settings.php file as follows:
```
$databases['migrate']['default'] = array (
  'database' => 'washgopc_GOPV7V2',
  'username' => 'gopdbadmin',
  'password' => '18WMTNwcta65',
  'prefix' => '',
  'host' => 'localhost',
  'port' => '3306',
  'namespace' => 'Drupal\\Core\\Database\\Driver\\mysql',
  'driver' => 'mysql',
);
```
In this case, "drupal7" is the legacy_db_key that will be used in the drush
migrate-upgrade command; database, username, and password are the parameters
used to access the drupal7 database.  [It was, of course,  necessary to use
mysql to add the gopdbadmin user and password].  Perhaps less obviously, it
was also necessary to add the user washgopc_gopdb; this is the user over on
the production site that actually created the .sql file we're trying to
import.

The drush command to create the migrations was then as follows:
```
drush migrate-upgrade --legacy-db-key=drupal7
      --legacy-root=https://www/wash-gop.com --configure-only
```
A word about migrations.  I'm not quite sure what they are and I spent a day
trying figure out how drupal remembers them.  Suffice it to say that drupal
DOES rmemember them, and that you can see them by going to
structure->migrations.  In my case, the migrations generated by the
migrate-upgrade command all belong to a "group" called migrate_drupal_7; we'll
use that group below in the drush migrate-import command.

-------------second commit-------------

The command to do the migrations is called import and it looks like this:
```
drush migrate-import --group=migrate_drupal_7
```
When I run this command the first time, the upgrade_d7_filter_format migration
fails with the following message:
```
4/9 [============>---------------]  44% [error]  The "" plugin does not exist.
Valid plugin IDs for Drupal\filter\FilterPluginManager are:
filter_html_image_secure, filter_url, filter_null, filter_html, filter_autop,
filter_align, filter_caption, filter_htmlcorrector, filter_html_escape 
(/var/www/drupal8vm/web/core/lib/Drupal/Component/Plugin/Discovery/DiscoveryTrait.php:53)
[error]  Missing filter plugin: filter_null.
```
 [notice] Processed 9 items (8 created, 0 updated, 1 failed, 0 ignored) - done with 'upgrade_d7_filter_format'
 
 
 
 -------------third commit-------------
 
 July 30, 2020 OK, it is now about 25 days since my last commit, and I have
 made some major changes in direction.  First, in early July I decided to
 abandon Vagrant and go with the Docker approach that Jeff was using.
 Here are some comments about that process:
 
 
 Stuff from July 8, 2020
 
 I made slight modifications to Jeff's naming conventions:
 
 * In my build command, I changed the name of the image I'm building to
 wdseelig:latest so this command looks like this:
    docker build -t wdseelig:latest .
    docker-compose up -d
 
 * In my docker-compose.yml file I changed the image: to wdseelig:latest
 [the one I just built above] and the container name to WCGOP
 
 * I added a second mysql container to hold the old Drupal 7 database. My
 docker-compose.yml file now creates 3 containers
 
 Once that was completed and I had a crude and preliminary version of my site
 running in a Docker container, I started running into still more problems with
 migrations, so I decided that I needed to have an IDE working with my system.
 It took several days to accomplish this, but on Sunday, July 26th, a red
 letter day if there ever was one,  I got that working, and by Thursday,
 July 30th, I was ready to make the commit that would capture the status.
 Here is the process that I went through:
 
* Started with Jeff's Dockerfile and a docker-compose.yml file to create the
Docker containers
* Included the following additions (Note that these are in the Dockerfile
that is used to create the container):
 	* installed xdebug and sshd server
 	* Wrote necessary xdebug configuration information to
 	/etc/php/7.4/mods-available/xdebug.ini file
 	* Installed the vim editor [necessary if I want to edit system files]
 	* Wrote ssh key information to /root/.ssh/authorized_keys file
* I spent a day and a half (!) trying to figure out how to start Apache and
sshd automatically when I brought up my containers.  I eventually gave up on
this and just created an alias, dssh, to start ssh service on my container.

Answering the above question about how drupal remembers migrations.  I spent a
lot of time looking the the database and everywhere else I could think of to
figure out where and how Drupal remembers which migrations have been created.
The answer, I think, is in the file structure of the Drupal code. If the D8
version of a module needs to bring data forward from D7, you put a .yml file
with the necessary instructions as to how to do this in its migrations file.
>modulename/migrations/modulemigration.yml

If you are creating a migration that you want to hold in a configuration file so that you can export it, you put it in a different directory:
>modulename/config/modulemigration.yml

 
 
 **Installing Drupal**
 
 Once you have all of the code loaded into the /var/html/www(/web) directory
you install Drupal with this command:
```
docker-compose exec drupal bash -c 'drush site:install minimal 
--db-url="mysql://drupal:$DRUPAL_DATABASE_PASSWORD@$DRUPAL_DATABASE_HOST/drupal"
--site-name="WCGOP" --existing-config -y'
```
TODO: Add `--existing-config` once we have configuration dumped.


NOTE THAT THIS COMMAND RE-INITIALIZES THE DRUPAL DATA BASE.  ANY MIGRATIONS
THAT YOU HAVE DONE WILL BE LOST??  IF YOU HAVE EXPORTED THE --existing-config
THEN I THINK THAT THOSE MIGRATIONS WILL BE IN `Structure->Migrations`, BUT THE
RESULTS OF THOSE MIGRATIONS WILL NOT BE IN THE DATABASE, SO YOU WILL HAVE TO
RE-RUN THEM. NOTE, ALSO, THAT RUNNING THIS COMMAND WILL PROBABLY DESTROY THE
`settings.php` FILE.  SO HERE IT IS IN CASE WE NEED TO REDO IT:
```
$databases['default']['default'] = array (
  'database' => 'drupal',
  'username' => 'drupal',
  'password' => 'drupal',
  'prefix' => '',
  'host' => 'mysql',
  'port' => '',
  'namespace' => 'Drupal\\Core\\Database\\Driver\\mysql',
  'driver' => 'mysql',
);
$databases['migrate']['default'] = array (
  'database' => 'washgopc_GOPV7V2',
  'username' => 'gopdbadmin',
  'password' => '18WMTNwcta65',
  'prefix' => '',
  'host' => 'docker.for.mac.localhost',
  'port' => '3307',
  'namespace' => 'Drupal\\Core\\Database\\Driver\\mysql',
  'driver' => 'mysql',
);
$settings['trusted_host_patterns'] = ['^localhost$',];
$settings['config_sync_directory'] = "../config/sync";
``` 

Note that $DRUPAL_DATABASE_PASSWORD and $DRUPAL_DATABASE_HOST are environmental
variables that are defined in the docker-compose.yml file that creates the
container.  The docker-compose command above is being run in that container,
and so has access to these variables.

Let's make sure we understand what this command does, and does not, do:
1. It does not touch the codebase in any way
1. It does not do any migrations, and therfore ...
1. When you do a drush site:install, you lose any content that you have
migrated into your site.  Example: If you have migrated in Page nodes, then the
D8 node_body table will have the html that was in those fields in your D7 site.
When you run the drush site:install command, all of that data will be lost
and you will have to re-run that migration.
1.  If you have saved your configuration data and if you have altered the
settings.php file to tell drupal where configuration data is saved, I think
that the site:install will re-import that configuration data.  This means that
when you go to Structure->Migrations, you will see the migrations that you
created earlier.  However, these migrations will not have been performed, so
you will have to re-run them.
1. I do not know whether configuration data will have been retained.  Example:
will the new site still have your site slogan??
1.  The broader nature of this question is "What information is in the database
(this will be lost when you re-install the site), and what information is in
the configuration (this will not be lost)?"

I have two "helper" commands in my .zshrc file:
1. `alias mywc='docker exec -it WCGOP bash'`
1. `alias dssh='docker exec -d WCGOP` /etc/init.d/ssh start'

**Composer memory limit problems**

Composer frequently runs out of memory.  One solution to this is to put
COMPOSER_MEMORY_LIMIT=-1 at the start of your composer command.  When even
this fails [with a terse "Killed' message], you can sometimes fix it by 
allowing more swap space for your system.  Docker make this easy, allowing you
go into Preferences->Resources to set the amount of swap space you want to
have.  So far, 2GB has worked for me.  This settings change takes place
immediately, you don't even have to restart your containers.

